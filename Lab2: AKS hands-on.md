<img src="../../img/logo.png" alt="Chmurowisko logo" width="200" align="right">
<br><br>
<br><br>
<br><br>

# Introduction to Azure Kubernetes Services

## LAB Overview

#### This lab will demonstrate:
* How to create cluster using Azure CLI.
* How to create namespace.
* How to deploy POD and service.
* How to create healtcheck

## Task 1: Create AKS cluster

1. Open web browser and go to: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows?view=azure-cli-latest 
2. Install Azure CLI. 
3. Open command line and type: az login 
4. Procced with instruction in console window. 
5. After login process type in console: <code> az aks create --resource-group student0X --name student0XCluster --generate-ssh-keys </code>
6. After cluster is deployed (it make takes up to 30 minutes), install Kubernetes CLI by typing in console: <code> az aks kubernetes install-cli </code> On Windows, the default installation is c:\program files (x86)\kubectl.exe. You may need to add this file to the Windows path. 
7. Get credentials to cluster: <code> az acs kubernetes get-credentials --resource-group student0X --name student0XCluster </code>
8. Verify connection using command: <code>kubectl get nodes </code>

## Task 2: Create secret and deploy POD

In this section, you will learn how to create deployment file and how to deploy it. 
 
1. Create secret for ACR: <code>kubectl create secret docker-registry <SECRET_NAME> --docker-server loginServerFromPoint6Task3 --docker-email <YOUR_MAIL> --docker-username= userNameCopiedFromPoint6Task3 --docker-password passwordCopiedFromPoint6Task3 </code>
2. Create deployment file (deployment.yml): 
<code>apiVersion: apps/v1beta1 
kind: Deployment 
metadata: 
  name: containerapp 
spec: 
  replicas: 1 
  template: 
    metadata: 
      labels: 
        app: containerapp 
    spec: 
      containers: 
      - name: containerapp 
        image: loginServerFromPoint6Task3/containerapp 
        ports: 
        - containerPort: 3000 
      imagePullSecrets: 
      - name: <SECRET_NAME> 
   </code>
3. Open console and type: <code>kubectl create â€“f pathToDeploymentFile </code>
4. Verify status using command: <code>kubectl get pods</code>

### Business Scenario
For the remainder of this lab, you will work with these Users and Groups to enable permissions supporting the following business scenario:

Your company is expecting and audit. You will be responsible for providing an access to logs stored on the S3 for an auditor.

## Task 2: Create and add User to the Group
You will create an IAM User for an auditor. You will add this user to the **S3-LogAudit** group so that he inherits the necessary permissions via the attached AmazonS3ReadOnlyAccess policy.

#### Create a new user

14. In the left navigation pane, click **Users**.
15. Click **Add user**, and configure following:
    * User name: your_username**_audit** (ex. student1_audit)
    * Access type : select **AWS Management Console access**
    * Console password: leave **Autogenerated password**
16. Leave the rest in default and click **Next:Permissions**.
17. In Set permissions tab select **Add user to group** and then select **S3-LogAudit** group.
18. Click **Next:Review,** and **Create user**.
19. Write down the password and click **Close**.

## Task 3: Sign-In and Test User
In this task, you will test the permissions of the IAM User created in task 2.

20. In the navigation pane on the left, click **Dashboard**.

An **IAM users sign-in link** is displayed It will look similar to:
https://123456789012.signin.aws.amazon.com/console
This is the same link you already used to sign-in to the AWS Account.

21. Copy the **IAM users sign-in** link to the notepad.
22. Open a web browser in a private mode.

**Google Chrome**
* Click the ellipsis at the top-right of the screen
* Click **New incognito window**

**Mozilla Firefox**
* Click the menu bars at the top-right of the screen
* Select **New Private Window**

**Microsoft Edge**
* Click the ellipsis at the top-right of the screen
* Click **New InPrivate window**

**Internet Explorer**
* Click the Tools menu option
* Click **InPrivate Browsing**

**Safari**
* Click **Files** in menu bar
* Select **New Private Window**

23. Paste the **IAM users sign-in** link into your private window and press Enter.
24. Sign-in with:
    * **IAM user name**: username created in step 15
    * **Password**: password copied in step 19
25. In the **Services** menu, click **S3**.
26. Click the name of **chmolabauditcsa** bucket and browse the contents.
    
Since your user is part of the **S3-LogAudit** Group in IAM, they have permission to view a list of Amazon S3 buckets and their contents.

Now, test whether you can put or delete any file from the bucket.

27. Click **Upload** and try to upload random file into the bucket.
You should get similar error: You are not authorized to perform this operation. This is because your user has been assigned permission only to list and get data from Amazon S3.

Next, test whether they have access to Amazon EC2.

28. In the **Services** menu, click **EC2**.
29. In the left navigation pane, click **Instances**.

You cannot see any instances! Instead, it says *An error occurred fetching instance data: You are not authorized to perform this operation..* This is because your user has not been assigned any permissions to use Amazon EC2.

## END LAB
Follow these steps to close the console, end your lab, and delete user created in step 15.

30. Sign **your_username_audit** out of the **AWS Management Console** by configuring the following:
    * At the top of the screen, click **your_username_audit**
    * Click **Sign Out**
31. Go back to your **main** laboratory console.
32. In the **Services** menu, click **IAM**.
33. In the left navigation pane, click **Users**.
34. Select your audit user and click **Delete user**.
35. Confirm by selecting **YES, delete**.

<br><br>

<center><p>&copy; 2019 Chmurowisko Sp. z o.o.<p></center>
